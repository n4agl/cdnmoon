-- =============================================
-- Cloudflare D1 生产级完整初始化脚本（2025版）
-- 直接复制全部内容到 D1 Console 或 wrangler d1 execute DB --file 执行即可
-- =============================================

-- 1. 基础 PRAGMA 设置（提升并发与稳定性）
PRAGMA journal_mode = WAL;          -- 必须，D1 默认已开启，但显式保险
PRAGMA synchronous = NORMAL;        -- 安全与性能平衡
PRAGMA foreign_keys = ON;           -- 开启外键约束
PRAGMA busy_timeout = 10000;        -- 10秒锁等待，彻底杜绝轻微并发下的 "database is locked"
PRAGMA wal_autocheckpoint = 100;    -- 防止 WAL 文件无限增长

-- 2. 用户表
CREATE TABLE IF NOT EXISTS users (
    username   TEXT    PRIMARY KEY,
    password   TEXT    NOT NULL,     -- 存储 bcrypt/argon2 哈希值
    created_at INTEGER NOT NULL DEFAULT (strftime('%s','now')),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
);

-- 3. 播放记录表（核心表）
CREATE TABLE IF NOT EXISTS play_records (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    username        TEXT    NOT NULL,
    key             TEXT    NOT NULL,                       -- 作品唯一标识（如 bangumi_id、tmdb_id）
    title           TEXT    NOT NULL,
    source_name     TEXT    NOT NULL,
    cover           TEXT    NOT NULL,
    year            TEXT    NOT NULL,
    index_episode   INTEGER NOT NULL,                       -- 当前看到第几集
    total_episodes  INTEGER NOT NULL,
    play_time       INTEGER NOT NULL,                       -- 本集已观看秒数
    total_time      INTEGER NOT NULL,                       -- 本集总时长秒数
    favorites_time  INTEGER NOT NULL DEFAULT 0,             -- 0=未收藏 >0=收藏时间戳
    save_time       INTEGER NOT NULL DEFAULT (strftime('%s','now')),
    search_title    TEXT,

    UNIQUE(username, key),
    FOREIGN KEY(username) REFERENCES users(username) ON DELETE CASCADE
);

-- 4. 收藏夹表
CREATE TABLE IF NOT EXISTS favorites (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    username        TEXT    NOT NULL,
    key             TEXT    NOT NULL,
    title           TEXT    NOT NULL,
    source_name     TEXT    NOT NULL,
    cover           TEXT    NOT NULL,
    year            TEXT    NOT NULL,
    total_episodes  INTEGER NOT NULL,
    save_time       INTEGER NOT NULL DEFAULT (strftime('%s','now')),

    UNIQUE(username, key),
    FOREIGN KEY(username) REFERENCES users(username) ON DELETE CASCADE
);

-- 5. 搜索历史表
CREATE TABLE IF NOT EXISTS search_history (
    id         INTEGER PRIMARY KEY AUTOINCREMENT,
    username   TEXT    NOT NULL,
    keyword    TEXT    NOT NULL,
    created_at INTEGER NOT NULL DEFAULT (strftime('%s','now')),

    UNIQUE(username, keyword),
    FOREIGN KEY(username) REFERENCES users(username) ON DELETE CASCADE
);

-- 6. 全局配置表（永远只有一条记录）
CREATE TABLE IF NOT EXISTS admin_config (
    id         INTEGER PRIMARY KEY DEFAULT 1 CHECK (id = 1),
    config     TEXT    NOT NULL DEFAULT '{}',      -- JSON 格式存储所有配置
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
);

-- 7. 片头片尾跳过配置表
CREATE TABLE IF NOT EXISTS skip_configs (
    id           INTEGER PRIMARY KEY AUTOINCREMENT,
    username     TEXT    NOT NULL,
    source       TEXT    NOT NULL,        -- 来源标识：alist、emby、jellyfin 等
    id_video     TEXT    NOT NULL,        -- 视频唯一 ID
    enable       INTEGER NOT NULL DEFAULT 1,
    intro_start  INTEGER NOT NULL DEFAULT 0,   -- 片头开始秒数
    intro_end    INTEGER NOT NULL DEFAULT 0,   -- 片头结束秒数
    outro_start  INTEGER NOT NULL DEFAULT 0,
    outro_end    INTEGER NOT NULL DEFAULT 0,
    updated_at   INTEGER NOT NULL DEFAULT (strftime('%s','now')),

    UNIQUE(username, source, id_video),
    FOREIGN KEY(username) REFERENCES users(username) ON DELETE CASCADE
);

-- =============================================
-- 性能索引（全部一次性创建（覆盖 99% 查询场景）
-- =============================================

-- 播放记录
CREATE INDEX IF NOT EXISTS idx_play_username              ON play_records(username);
CREATE UNIQUE INDEX IF NOT EXISTS idx_play_username_key   ON play_records(username, key);
CREATE INDEX IF NOT EXISTS idx_play_save_time             ON play_records(save_time DESC);
CREATE INDEX IF NOT EXISTS idx_play_favorites             ON play_records(username, favorites_time DESC);

-- 收藏夹
CREATE INDEX IF NOT EXISTS idx_fav_username               ON favorites(username);
CREATE UNIQUE INDEX IF NOT EXISTS idx_fav_username_key    ON favorites(username, key);
CREATE INDEX IF NOT EXISTS idx_fav_save_time              ON favorites(save_time DESC);

-- 搜索历史
CREATE INDEX IF NOT EXISTS idx_search_username            ON search_history(username);
CREATE INDEX IF NOT EXISTS idx_search_created             ON search_history(created_at DESC);

-- 跳过配置
CREATE UNIQUE INDEX IF NOT EXISTS idx_skip_unique         ON skip_configs(username, source, id_video);

-- 首页“继续观看”常用覆盖索引（极致性能）
CREATE INDEX IF NOT EXISTS idx_play_covering ON play_records(
    username,
    save_time DESC,
    key,
    title,
    source_name,
    cover,
    year,
    index_episode,
    total_episodes,
    play_time,
    total_time
);

-- =============================================
-- 初始化默认数据
-- =============================================
INSERT OR IGNORE INTO admin_config (id, config) VALUES (1, '{"initialized": true, "version": "2025.01"}');

-- =============================================
-- 最后优化
-- =============================================
PRAGMA optimize;
